<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/board.css}">
    <link rel="stylesheet" th:href="@{/css/button.css}">
    <link rel="stylesheet" th:href="@{/css/menu.css}">
    <link rel="stylesheet" th:href="@{/css/controls.css}">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
    <link rel="icon" sizes="any" th:href="@{/images/logo.svg}" type="image/svg+xml">
    <title th:text="Battleship"></title>
</head>

<body>
<main class="main">
    <div>
        <h2 class="main__info" id="turn-indicator">Waiting for setup...</h2>
        <div class="board__grid">
            <div class="board board__left">
                <button class="board__tile" th:data-index="${i}" th:each="i : ${#numbers.sequence(0, 99)}"></button>
            </div>
            <div class="board board__right">
                <button class="board__tile" th:data-index="${i}" th:each="i : ${#numbers.sequence(0, 99)}"></button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="control-button button" onclick="createGame()">Create Game</button>
        <button class="control-button button" onclick="createPlayer()">Create Player</button>
        <button class="control-button button" onclick="placeShip()">Place Ship</button>
    </div>
</main>

<script>
    let gameId = null;
    let playerId = null;
    let currentPlayerTurn = null;
    let player1Id = null;
    let player2Id = null;
    let player1Name = null;
    let player2Name = null;
    let player1ShipsPlaced = false;
    let player2ShipsPlaced = false;

    document.addEventListener('DOMContentLoaded', () => {
        const rightBoardTiles = document.querySelectorAll('.board__right .board__tile');

        rightBoardTiles.forEach(tile => {
            tile.addEventListener('click', () => {
                const index = tile.getAttribute('data-index');
                shootCell(index);
            });
        });
    });

    function updateTurnIndicator() {
        const turnIndicator = document.getElementById('turn-indicator');
        if (!player1ShipsPlaced || !player2ShipsPlaced) {
            turnIndicator.textContent = 'Waiting for setup...';
        } else if (currentPlayerTurn === player1Id) {
            turnIndicator.textContent = `${player1Name}'s turn!`;
        } else if (currentPlayerTurn === player2Id) {
            turnIndicator.textContent = `${player2Name}'s turn!`;
        }
    }

    function createGame() {
        fetch('/game/create', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                gameId = data.id;
                console.log('Game created with ID:', gameId);
                currentPlayerTurn = null;
                player1ShipsPlaced = false;
                player2ShipsPlaced = false;
                updateTurnIndicator();
            })
            .catch(error => console.error('Error creating game:', error));
    }

    function createPlayer() {
        const name = prompt('Enter your name:');
        if (name && gameId) {
            fetch(`/player/create/${gameId}?name=${name}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    playerId = data.id;
                    if (!player1Id) {
                        player1Id = playerId;
                        player1Name = name;
                        alert('Player 1 created. Now place your ships.');
                    } else if (!player2Id) {
                        player2Id = playerId;
                        player2Name = name;
                        alert('Player 2 created. Now place your ships.');
                    }
                    console.log('Player created with ID:', playerId);
                    updateTurnIndicator();
                })
                .catch(error => console.error('Error creating player:', error));
        } else {
            alert('Please create a game first and enter a name.');
        }
    }

    function placeShip() {
        if (playerId) {
            const shipType = prompt('Enter ship type (CARRIER, BATTLESHIP, DESTROYER, SUBMARINE, PATROL_BOAT):');
            const row = prompt('Enter starting row (0-9):');
            const col = prompt('Enter starting column (0-9):');
            const isHorizontal = confirm('Is the ship horizontal? (OK for Yes, Cancel for No)');

            if (shipType && row && col) {
                fetch(`/player/${playerId}/placeShip?shipType=${shipType}&row=${row}&col=${col}&isHorizontal=${isHorizontal}`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Ship placed:', data);
                        if (playerId === player1Id) {
                            player1ShipsPlaced = true;
                        } else if (playerId === player2Id) {
                            player2ShipsPlaced = true;
                        }
                        if (player1ShipsPlaced && player2ShipsPlaced) {
                            currentPlayerTurn = player1Id;
                            updateTurnIndicator();
                            alert('All ships placed. Player 1 starts shooting!');
                        }

                        addShipToBoard(shipType, row, col, isHorizontal);
                    })
                    .catch(error => console.error('Error placing ship:', error));
            }
        } else {
            alert('Please create a player first.');
        }
    }

    function addShipToBoard(shipType, row, col, isHorizontal) {
        const shipSize = {
            CARRIER: 5,
            BATTLESHIP: 4,
            DESTROYER: 3,
            SUBMARINE: 3,
            PATROL_BOAT: 2
        }[shipType.toUpperCase()];

        const cellSize = 32;
        const gap = 4;
        const padding = 22;
        const shipDiv = document.createElement('div');

        shipDiv.classList.add('ship');
        shipDiv.style.width = isHorizontal ? `${shipSize * cellSize + (shipSize - 1) * 4}px` : `${cellSize}px`;
        shipDiv.style.height = isHorizontal ? `${cellSize}px` : `${shipSize * cellSize + (shipSize - 1) * 4}px`;

        const left = padding + col * (cellSize + gap);
        const top = padding + row * (cellSize + gap);

        shipDiv.style.left = `${left}px`;
        shipDiv.style.top = `${top}px`;

        const board = document.querySelector('.board__left');
        board.appendChild(shipDiv);
    }

    function shootCell(index) {
        if (gameId && player1ShipsPlaced && player2ShipsPlaced) {
            const row = Math.floor(index / 10);
            const col = index % 10;

            const shootingPlayerId = currentPlayerTurn;
            fetch(`/game/${gameId}/player/${shootingPlayerId}/shoot?row=${row}&col=${col}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Cell shot:', data);
                    const cell = document.querySelector(`.board__right .board__tile[data-index="${index}"]`);
                    if (cell) {
                        cell.classList.add('shot');
                    }

                    currentPlayerTurn = (currentPlayerTurn === player1Id) ? player2Id : player1Id;
                    updateTurnIndicator();
                })
                .catch(error => console.error('Error shooting cell:', error));
        } else {
            alert('The game is not ready or ships are not placed.');
        }
    }
</script>
</body>
</html>
